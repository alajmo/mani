#!/bin/bash

set -e
set -o pipefail

APPNAME=mani
PROJECT_DIR=$(dirname "$(cd "$(dirname "${0}")"; pwd -P)")

function help() {
  cat >&2 << EOF
This script is a driver for "runtime tests".
The "runtime test" is to test this package in specific environments,
defined by Dockerfiles.

Options:
  --test|-t {case}     Run only cases which have specified pattern in the case names
  --count|-c {count}   Run tests multiple times, the clean flag is necessary for this flag
  --help|-h            Show this message

Examples:

  ./test/run.sh

EOF
}

function parse_options() {
  RUN=
  COUNT=
  UPDATE_GOLDEN=
  CLEAN=
  DEBUG=
  while [[ $# -gt 0 ]]; do
    case "${1}" in
      --debug|-d)
        DEBUG="-debug"
        shift
        ;;
      --clean)
        CLEAN="-clean"
        shift
        ;;
      --run|-t)
        RUN="-run=${2}"
        shift && shift
        ;;
      --count|-c)
        COUNT="-count=${2}"
        shift && shift
        ;;
      --update-golden|-u)
        UPDATE_GOLDEN="-update"
        shift
        ;;
      --help|-h)
        help && exit 0
        ;;
      *)
        printf "Unkown flag: ${1}\n\n"
        help
        exit 1
        ;;
    esac
  done
}

function run_tests() {
  for runtime in `ls ${PROJECT_DIR}/test/images/*test.Dockerfile`; do
    testcase=`basename ${runtime} | sed -e s/\.test\.Dockerfile$//`
    tag="${APPNAME}/test:${testcase}"

    echo "┌───────────── ${testcase}"
    echo "│ [Docker] Running tests..."
    docker run                                                                 \
      -it --rm                                                                 \
      --user "$(id -u):$(id -g)"                                               \
      --volume "$PWD:/home/test"                                                     \
      ${APPNAME}/test:${testcase}                                              \
      /bin/sh -c "go test -v ./... $RUN $COUNT $CLEAN $DEBUG $UPDATE_GOLDEN" | \
      sed "s/^/│ [${testcase}] /"

    echo "└───────────── ${testcase} [OK]"
  done
}

function __main__() {
  parse_options $@
  run_tests
}

__main__ $@
